<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualisasi COVID-19 Indonesia</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #333;
        }
        .controls {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        .control-group {
            display: flex;
            flex-direction: column;
        }
        label {
            margin-bottom: 5px;
            font-weight: bold;
        }
        select, input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .chart-container {
            margin-bottom: 30px;
        }
        .province-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
        }
        .province-item {
            margin-bottom: 5px;
        }
        .province-item label {
            font-weight: normal;
            cursor: pointer;
        }
        .tooltip {
            position: absolute;
            padding: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 4px;
            pointer-events: none;
            font-size: 12px;
        }
        .legend {
            font-size: 12px;
        }
        .axis-label {
            font-size: 14px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Visualisasi Data COVID-19 Indonesia per Provinsi</h1>
        <p>Dashboard interaktif untuk mengeksplorasi perkembangan kasus COVID-19 di berbagai provinsi Indonesia</p>
        
        <div class="controls">
            <div class="control-group">
                <label for="metric-select">Metrik:</label>
                <select id="metric-select">
                    <option value="Total Cases">Total Kasus</option>
                    <option value="New Cases">Kasus Baru</option>
                    <option value="Total Deaths">Total Kematian</option>
                    <option value="New Deaths">Kematian Baru</option>
                    <option value="Total Recovered">Total Sembuh</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="date-slider">Tanggal:</label>
                <input type="range" id="date-slider" min="0" max="100" value="100">
                <span id="date-display"></span>
            </div>
            
            <div class="control-group">
                <label>Provinsi:</label>
                <div class="province-list" id="province-list">
                    <!-- Province checkboxes will be populated here -->
                </div>
            </div>
            
            <div class="control-group">
                <button id="select-all">Pilih Semua</button>
                <button id="deselect-all">Hapus Semua</button>
            </div>
        </div>
        
        <div class="chart-container">
            <h2>Perkembangan Kasus COVID-19 per Provinsi</h2>
            <div id="line-chart"></div>
        </div>
        
        <div class="chart-container">
            <h2>Perbandingan Kasus dan Kematian</h2>
            <div id="scatter-plot"></div>
        </div>
        
        <div class="chart-container">
            <h2>Distribusi Kasus per Provinsi</h2>
            <div id="bar-chart"></div>
        </div>
    </div>

    <script>
        // Global variables
        let covidData = [];
        let selectedProvinces = [];
        let allProvinces = [];
        let dateRange = [];
        let currentMetric = 'Total Cases';
        
        // Dimensions and margins
        const margin = { top: 20, right: 80, bottom: 50, left: 60 };
        const width = 900 - margin.left - margin.right;
        const height = 400 - margin.top - margin.bottom;
        
        // Load and process data
        d3.csv('covid_indonesia_province_cleaned.csv').then(function(data) {
            // Parse the data
            covidData = data.map(d => {
                // Parse date
                const dateParts = d.Date.split('/');
                const date = new Date(parseInt(dateParts[2]), parseInt(dateParts[0])-1, parseInt(dateParts[1]));
                
                return {
                    date: date,
                    province: d.Province,
                    newCases: +d['New Cases'],
                    newDeaths: +d['New Deaths'],
                    totalCases: +d['Total Cases'],
                    totalDeaths: +d['Total Deaths'],
                    totalRecovered: +d['Total Recovered']
                };
            });
            
            // Get all provinces
            allProvinces = [...new Set(covidData.map(d => d.province))].sort();
            
            // Get date range
            dateRange = [...new Set(covidData.map(d => d.date))].sort((a, b) => a - b);
            
            // Initialize with top 5 provinces by total cases
            const provinceTotals = {};
            allProvinces.forEach(province => {
                const provinceData = covidData.filter(d => d.province === province);
                const latestData = provinceData[provinceData.length - 1];
                provinceTotals[province] = latestData.totalCases;
            });
            
            // Sort provinces by total cases and take top 5
            const topProvinces = Object.entries(provinceTotals)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(d => d[0]);
                
            selectedProvinces = topProvinces;
            
            // Initialize UI
            initializeUI();
            
            // Create visualizations
            createLineChart();
            createScatterPlot();
            createBarChart();
        });
        
        function initializeUI() {
            // Populate province list
            const provinceList = d3.select('#province-list');
            provinceList.selectAll('*').remove();
            
            allProvinces.forEach(province => {
                const isChecked = selectedProvinces.includes(province);
                provinceList.append('div')
                    .attr('class', 'province-item')
                    .html(`<label><input type="checkbox" value="${province}" ${isChecked ? 'checked' : ''}> ${province}</label>`);
            });
            
            // Add event listeners to province checkboxes
            provinceList.selectAll('input')
                .on('change', function() {
                    const province = this.value;
                    if (this.checked) {
                        if (!selectedProvinces.includes(province)) {
                            selectedProvinces.push(province);
                        }
                    } else {
                        selectedProvinces = selectedProvinces.filter(p => p !== province);
                    }
                    updateCharts();
                });
                
            // Add select all/deselect all buttons
            d3.select('#select-all').on('click', function() {
                selectedProvinces = [...allProvinces];
                provinceList.selectAll('input').property('checked', true);
                updateCharts();
            });
            
            d3.select('#deselect-all').on('click', function() {
                selectedProvinces = [];
                provinceList.selectAll('input').property('checked', false);
                updateCharts();
            });
            
            // Add metric selector listener
            d3.select('#metric-select').on('change', function() {
                currentMetric = this.value;
                updateCharts();
            });
            
            // Add date slider listener
            const dateSlider = d3.select('#date-slider');
            dateSlider.attr('max', dateRange.length - 1);
            
            dateSlider.on('input', function() {
                const dateIndex = +this.value;
                const currentDate = dateRange[dateIndex];
                d3.select('#date-display').text(formatDate(currentDate));
                updateCharts();
            });
            
            // Initialize date display
            d3.select('#date-display').text(formatDate(dateRange[dateRange.length - 1]));
        }
        
        function createLineChart() {
            const svg = d3.select('#line-chart')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
                
            // Add tooltip
            const tooltip = d3.select('body').append('div')
                .attr('class', 'tooltip')
                .style('opacity', 0);
                
            // Store the svg for updates
            window.lineChartSvg = svg;
            window.lineChartTooltip = tooltip;
            
            updateLineChart();
        }
        
        function updateLineChart() {
            const svg = window.lineChartSvg;
            const tooltip = window.lineChartTooltip;
            
            // Clear previous content
            svg.selectAll('*').remove();
            
            // Filter data by selected provinces
            const filteredData = covidData.filter(d => selectedProvinces.includes(d.province));
            
            // Group data by province
            const dataByProvince = d3.group(filteredData, d => d.province);
            
            // Create scales
            const xScale = d3.scaleTime()
                .domain(d3.extent(dateRange))
                .range([0, width]);
                
            const yMax = d3.max(Array.from(dataByProvince.values()), provinceData => 
                d3.max(provinceData, d => d[currentMetric.toLowerCase().replace(' ', '')])
            );
            
            const yScale = d3.scaleLinear()
                .domain([0, yMax])
                .range([height, 0]);
                
            // Create line generator
            const line = d3.line()
                .x(d => xScale(d.date))
                .y(d => yScale(d[currentMetric.toLowerCase().replace(' ', '')]))
                .curve(d3.curveMonotoneX);
                
            // Add axes
            svg.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(xScale).tickFormat(d3.timeFormat('%b %Y')));
                
            svg.append('g')
                .call(d3.axisLeft(yScale));
                
            // Add axis labels
            svg.append('text')
                .attr('transform', 'rotate(-90)')
                .attr('y', 0 - margin.left)
                .attr('x', 0 - (height / 2))
                .attr('dy', '1em')
                .attr('class', 'axis-label')
                .style('text-anchor', 'middle')
                .text(currentMetric);
                
            svg.append('text')
                .attr('transform', `translate(${width / 2}, ${height + margin.bottom - 10})`)
                .attr('class', 'axis-label')
                .style('text-anchor', 'middle')
                .text('Tanggal');
                
            // Create color scale
            const colorScale = d3.scaleOrdinal(d3.schemeCategory10)
                .domain(selectedProvinces);
                
            // Draw lines
            const lines = svg.selectAll('.line')
                .data(Array.from(dataByProvince))
                .enter()
                .append('g');
                
            lines.append('path')
                .attr('class', 'line')
                .attr('d', d => line(d[1]))
                .style('stroke', d => colorScale(d[0]))
                .style('stroke-width', 2)
                .style('fill', 'none');
                
            // Add dots for interaction
            lines.selectAll('.dot')
                .data(d => d[1])
                .enter()
                .append('circle')
                .attr('class', 'dot')
                .attr('cx', d => xScale(d.date))
                .attr('cy', d => yScale(d[currentMetric.toLowerCase().replace(' ', '')]))
                .attr('r', 3)
                .style('fill', d => colorScale(d.province))
                .style('opacity', 0.7)
                .on('mouseover', function(event, d) {
                    tooltip.transition()
                        .duration(200)
                        .style('opacity', .9);
                    tooltip.html(`
                        <strong>${d.province}</strong><br/>
                        ${formatDate(d.date)}<br/>
                        ${currentMetric}: ${d[currentMetric.toLowerCase().replace(' ', '')]}
                    `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 28) + 'px');
                })
                .on('mouseout', function() {
                    tooltip.transition()
                        .duration(500)
                        .style('opacity', 0);
                });
                
            // Add legend
            const legend = svg.selectAll('.legend')
                .data(selectedProvinces)
                .enter()
                .append('g')
                .attr('class', 'legend')
                .attr('transform', (d, i) => `translate(${width + 10}, ${i * 20})`);
                
            legend.append('rect')
                .attr('x', 0)
                .attr('width', 18)
                .attr('height', 18)
                .style('fill', d => colorScale(d));
                
            legend.append('text')
                .attr('x', 25)
                .attr('y', 9)
                .attr('dy', '.35em')
                .style('text-anchor', 'start')
                .text(d => d);
        }
        
        function createScatterPlot() {
            const svg = d3.select('#scatter-plot')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
                
            // Store the svg for updates
            window.scatterPlotSvg = svg;
            
            updateScatterPlot();
        }
        
        function updateScatterPlot() {
            const svg = window.scatterPlotSvg;
            
            // Clear previous content
            svg.selectAll('*').remove();
            
            // Get the latest data for each province
            const latestData = [];
            selectedProvinces.forEach(province => {
                const provinceData = covidData.filter(d => d.province === province);
                const latest = provinceData[provinceData.length - 1];
                latestData.push(latest);
            });
            
            // Create scales
            const xMax = d3.max(latestData, d => d.totalCases);
            const xScale = d3.scaleLog()
                .domain([1, xMax])
                .range([0, width]);
                
            const yMax = d3.max(latestData, d => d.totalDeaths);
            const yScale = d3.scaleLog()
                .domain([1, yMax])
                .range([height, 0]);
                
            // Create color scale
            const colorScale = d3.scaleOrdinal(d3.schemeCategory10)
                .domain(selectedProvinces);
                
            // Add axes
            svg.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(xScale));
                
            svg.append('g')
                .call(d3.axisLeft(yScale));
                
            // Add axis labels
            svg.append('text')
                .attr('transform', 'rotate(-90)')
                .attr('y', 0 - margin.left)
                .attr('x', 0 - (height / 2))
                .attr('dy', '1em')
                .attr('class', 'axis-label')
                .style('text-anchor', 'middle')
                .text('Total Kematian');
                
            svg.append('text')
                .attr('transform', `translate(${width / 2}, ${height + margin.bottom - 10})`)
                .attr('class', 'axis-label')
                .style('text-anchor', 'middle')
                .text('Total Kasus');
                
            // Add dots
            svg.selectAll('.dot')
                .data(latestData)
                .enter()
                .append('circle')
                .attr('class', 'dot')
                .attr('cx', d => xScale(d.totalCases))
                .attr('cy', d => yScale(d.totalDeaths))
                .attr('r', 8)
                .style('fill', d => colorScale(d.province))
                .style('opacity', 0.7);
                
            // Add labels
            svg.selectAll('.label')
                .data(latestData)
                .enter()
                .append('text')
                .attr('x', d => xScale(d.totalCases) + 10)
                .attr('y', d => yScale(d.totalDeaths))
                .text(d => d.province)
                .attr('font-size', '10px')
                .attr('fill', '#333');
                
            // Add reference line for case fatality rate
            const cfrs = [0.01, 0.05, 0.1]; // 1%, 5%, 10% CFR
            cfrs.forEach(cfr => {
                const lineData = [
                    {x: 1, y: 1 * cfr},
                    {x: xMax, y: xMax * cfr}
                ];
                
                const line = d3.line()
                    .x(d => xScale(d.x))
                    .y(d => yScale(d.y));
                    
                svg.append('path')
                    .datum(lineData)
                    .attr('d', line)
                    .style('stroke', '#ccc')
                    .style('stroke-width', 1)
                    .style('fill', 'none')
                    .style('stroke-dasharray', '5,5');
                    
                // Add label for CFR line
                if (cfr === 0.05) {
                    svg.append('text')
                        .attr('x', xScale(xMax * 0.7))
                        .attr('y', yScale(xMax * 0.7 * cfr) - 5)
                        .text(`CFR ${(cfr * 100).toFixed(1)}%`)
                        .attr('font-size', '10px')
                        .attr('fill', '#999');
                }
            });
        }
        
        function createBarChart() {
            const svg = d3.select('#bar-chart')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
                
            // Store the svg for updates
            window.barChartSvg = svg;
            
            updateBarChart();
        }
        
        function updateBarChart() {
            const svg = window.barChartSvg;
            
            // Clear previous content
            svg.selectAll('*').remove();
            
            // Get the latest data for each province
            const latestData = [];
            selectedProvinces.forEach(province => {
                const provinceData = covidData.filter(d => d.province === province);
                const latest = provinceData[provinceData.length - 1];
                latestData.push({
                    province: province,
                    totalCases: latest.totalCases,
                    totalDeaths: latest.totalDeaths,
                    totalRecovered: latest.totalRecovered
                });
            });
            
            // Sort by total cases
            latestData.sort((a, b) => b.totalCases - a.totalCases);
            
            // Create scales
            const xScale = d3.scaleBand()
                .domain(latestData.map(d => d.province))
                .range([0, width])
                .padding(0.2);
                
            const yMax = d3.max(latestData, d => d.totalCases);
            const yScale = d3.scaleLinear()
                .domain([0, yMax])
                .range([height, 0]);
                
            // Create color scale
            const colorScale = d3.scaleOrdinal()
                .domain(['totalCases', 'totalDeaths', 'totalRecovered'])
                .range(['#1f77b4', '#d62728', '#2ca02c']);
                
            // Add axes
            svg.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(xScale))
                .selectAll('text')
                .attr('transform', 'rotate(-45)')
                .style('text-anchor', 'end');
                
            svg.append('g')
                .call(d3.axisLeft(yScale));
                
            // Add axis labels
            svg.append('text')
                .attr('transform', 'rotate(-90)')
                .attr('y', 0 - margin.left)
                .attr('x', 0 - (height / 2))
                .attr('dy', '1em')
                .attr('class', 'axis-label')
                .style('text-anchor', 'middle')
                .text('Jumlah');
                
            // Add bars
            const bars = svg.selectAll('.bar')
                .data(latestData)
                .enter()
                .append('g')
                .attr('class', 'bar')
                .attr('transform', d => `translate(${xScale(d.province)},0)`);
                
            // Total cases bar
            bars.append('rect')
                .attr('x', 0)
                .attr('y', d => yScale(d.totalCases))
                .attr('width', xScale.bandwidth() / 3)
                .attr('height', d => height - yScale(d.totalCases))
                .style('fill', colorScale('totalCases'));
                
            // Total deaths bar
            bars.append('rect')
                .attr('x', xScale.bandwidth() / 3)
                .attr('y', d => yScale(d.totalDeaths))
                .attr('width', xScale.bandwidth() / 3)
                .attr('height', d => height - yScale(d.totalDeaths))
                .style('fill', colorScale('totalDeaths'));
                
            // Total recovered bar
            bars.append('rect')
                .attr('x', 2 * xScale.bandwidth() / 3)
                .attr('y', d => yScale(d.totalRecovered))
                .attr('width', xScale.bandwidth() / 3)
                .attr('height', d => height - yScale(d.totalRecovered))
                .style('fill', colorScale('totalRecovered'));
                
            // Add legend
            const legendData = [
                {label: 'Total Kasus', color: colorScale('totalCases')},
                {label: 'Total Kematian', color: colorScale('totalDeaths')},
                {label: 'Total Sembuh', color: colorScale('totalRecovered')}
            ];
            
            const legend = svg.selectAll('.legend')
                .data(legendData)
                .enter()
                .append('g')
                .attr('class', 'legend')
                .attr('transform', (d, i) => `translate(${width - 100}, ${i * 20})`);
                
            legend.append('rect')
                .attr('x', 0)
                .attr('width', 18)
                .attr('height', 18)
                .style('fill', d => d.color);
                
            legend.append('text')
                .attr('x', 25)
                .attr('y', 9)
                .attr('dy', '.35em')
                .style('text-anchor', 'start')
                .text(d => d.label);
        }
        
        function updateCharts() {
            updateLineChart();
            updateScatterPlot();
            updateBarChart();
        }
        
        function formatDate(date) {
            return d3.timeFormat('%d %b %Y')(date);
        }
    </script>
</body>
</html>
